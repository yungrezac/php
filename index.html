<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniApp</title>
  <!-- Подключаем Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Ionicons -->
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
  <!-- Supabase JS (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .slide-up { animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(59,130,246, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(59,130,246, 0); }
      100% { box-shadow: 0 0 0 0 rgba(59,130,246, 0); }
    }
    .smooth-transition { transition: all 0.3s ease; }
    ::-webkit-scrollbar { width: 6px; height:6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
    * { scrollbar-width: thin; scrollbar-color: #888 #f1f1f1; }
    .toggle { position: relative; display:inline-block; width:50px; height:24px; }
    .toggle input { opacity: 0; width:0; height:0; }
    .toggle-slider {
      position: absolute; cursor:pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc; transition: .4s; border-radius:24px;
    }
    .toggle-slider:before {
      position: absolute; content:"";
      height: 16px; width: 16px; left:4px; bottom:4px;
      background-color: white; transition: .4s; border-radius:50%;
    }
    .toggle input:checked + .toggle-slider { background-color: #3b82f6; }
    .toggle input:checked + .toggle-slider:before { transform: translateX(26px); }
  </style>
</head>
<body class="bg-white text-black font-sans antialiased">
  <!-- Top Bar -->
  <div id="topBar" class="fixed top-0 left-0 w-full h-12 flex items-center justify-center border-b bg-white font-semibold text-gray-800 relative z-10 shadow-sm">
    <span id="topBarTitle">Заявки</span>
    <div id="notifIconWrapper" class="absolute right-4 cursor-pointer">
      <ion-icon name="notifications-outline" class="text-2xl text-gray-600 hover:text-blue-500 smooth-transition"></ion-icon>
      <span id="notifDot" class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full hidden"></span>
    </div>
    <div id="notifPanel" class="hidden absolute right-2 top-full mt-1 w-72 bg-white border border-gray-200 rounded-lg shadow-xl p-3 text-sm text-gray-700 z-20">
      <div class="flex justify-between items-center mb-2 pb-2 border-b">
        <h4 class="font-medium">Уведомления</h4>
        <button id="markAllAsReadBtn" class="text-blue-500 text-xs">Прочитать все</button>
      </div>
      <div class="space-y-3 max-h-80 overflow-y-auto" id="notificationsList"></div>
    </div>
  </div>

  <!-- Основные разделы -->
  <!-- Здесь оставляем разметку для различных вкладок; основной раздел (заявки) показан ниже -->
  <div id="tabContent-articles" class="tabContent px-4 mt-12 pb-16 hidden">
    <div class="relative mb-4">
      <input type="text" id="articleSearch" placeholder="Поиск статей..." class="w-full border border-gray-300 rounded-full px-4 py-2 pl-10 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent smooth-transition">
      <ion-icon name="search-outline" class="absolute left-3 top-3 text-gray-400 text-lg"></ion-icon>
    </div>
    <div class="space-y-3" id="articlesList"></div>
    <div id="articlesLoading" class="flex justify-center py-4">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
    </div>
  </div>

  <div id="tabContent-market" class="tabContent px-4 mt-12 pb-16 hidden">
    <div id="addTemplateCard" class="hidden border-2 border-dashed border-gray-400 rounded-lg p-4 flex items-center justify-center text-gray-600 mb-4 cursor-pointer hover:bg-gray-50 smooth-transition">
      <ion-icon name="add-circle-outline" class="text-2xl mr-2"></ion-icon>
      <span>Добавить шаблон</span>
    </div>
    <div class="flex mb-4 gap-2">
      <div class="relative flex-1">
        <input type="text" placeholder="Поиск шаблонов..." id="marketSearch" class="w-full border border-gray-300 rounded-lg px-4 py-2 pl-10 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent smooth-transition">
        <ion-icon name="search-outline" class="absolute left-3 top-3 text-gray-400 text-lg"></ion-icon>
      </div>
      <button id="filterTemplatesBtn" class="bg-gray-100 p-2 rounded-lg hover:bg-gray-200 smooth-transition">
        <ion-icon name="filter-outline" class="text-gray-600 text-lg"></ion-icon>
      </button>
    </div>
    <div id="marketFilters" class="hidden mb-4 p-3 bg-gray-50 rounded-lg">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Категория</label>
          <select id="templateCategoryFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="all">Все</option>
            <option value="UI">UI шаблоны</option>
            <option value="functional">Функциональные</option>
            <option value="games">Игры</option>
            <option value="other">Другое</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Цена</label>
          <select id="templatePriceFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="all">Любая</option>
            <option value="0-10">0-10 TON</option>
            <option value="10-50">10-50 TON</option>
            <option value="50+">50+ TON</option>
          </select>
        </div>
      </div>
      <div class="mt-3 flex justify-between">
        <button id="resetFiltersBtn" class="text-blue-500 text-sm hover:text-blue-700 smooth-transition">Сбросить</button>
        <button id="applyFiltersBtn" class="bg-blue-500 text-white text-sm px-3 py-1 rounded-lg hover:bg-blue-600 smooth-transition">Применить</button>
      </div>
    </div>
    <div class="space-y-3" id="templatesList"></div>
    <div id="templatesLoading" class="flex justify-center py-4">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
    </div>
    <div id="noTemplatesMessage" class="hidden text-center py-8 text-gray-500">
      <ion-icon name="search-outline" class="text-3xl mb-2"></ion-icon>
      <p>Шаблонов не найдено</p>
      <button id="resetFiltersBtn2" class="text-blue-500 text-sm mt-2 hover:text-blue-700 smooth-transition">Сбросить фильтры</button>
    </div>
  </div>

  <div id="tabContent-requests" class="tabContent px-4 mt-12 pb-16">
    <div id="customerRequests">
      <button id="newRequestBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg mb-4 w-full flex items-center justify-center smooth-transition pulse">
        <ion-icon name="add-outline" class="text-xl mr-2"></ion-icon>
        <span>Новая заявка</span>
      </button>
      <div class="space-y-3" id="customerRequestsList"></div>
      <div id="noCustomerRequests" class="hidden text-center py-8 text-gray-500">
        <ion-icon name="clipboard-outline" class="text-3xl mb-2"></ion-icon>
        <p>У вас пока нет заявок</p>
        <button id="createRequestBtn" class="text-blue-500 text-sm mt-2 hover:text-blue-700 smooth-transition">Создать заявку</button>
      </div>
    </div>
    <div id="developerRequests" class="hidden">
      <div class="flex mb-4 gap-2">
        <div class="relative flex-1">
          <input type="text" placeholder="Поиск заявок..." id="requestSearch" class="w-full border border-gray-300 rounded-lg px-4 py-2 pl-10 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent smooth-transition">
          <ion-icon name="search-outline" class="absolute left-3 top-3 text-gray-400 text-lg"></ion-icon>
        </div>
        <button id="filterRequestsBtn" class="bg-gray-100 p-2 rounded-lg hover:bg-gray-200 smooth-transition">
          <ion-icon name="filter-outline" class="text-gray-600 text-lg"></ion-icon>
        </button>
      </div>
      <div id="requestFilters" class="hidden mb-4 p-3 bg-gray-50 rounded-lg">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Бюджет</label>
            <select id="requestBudgetFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="all">Любой</option>
              <option value="0-50">0-50 TON</option>
              <option value="50-100">50-100 TON</option>
              <option value="100+">100+ TON</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Срок</label>
            <select id="requestDeadlineFilter" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="all">Любой</option>
              <option value="1-3">1-3 дня</option>
              <option value="3-7">3-7 дней</option>
              <option value="7+">7+ дней</option>
            </select>
          </div>
        </div>
        <div class="mt-3 flex justify-between">
          <button id="resetRequestFiltersBtn" class="text-blue-500 text-sm hover:text-blue-700 smooth-transition">Сбросить</button>
          <button id="applyRequestFiltersBtn" class="bg-blue-500 text-white text-sm px-3 py-1 rounded-lg hover:bg-blue-600 smooth-transition">Применить</button>
        </div>
      </div>
      <div class="space-y-3" id="developerRequestsList"></div>
      <div id="noDeveloperRequests" class="hidden text-center py-8 text-gray-500">
        <ion-icon name="clipboard-outline" class="text-3xl mb-2"></ion-icon>
        <p>Нет доступных заявок</p>
        <button id="refreshRequestsBtn" class="text-blue-500 text-sm mt-2 hover:text-blue-700 smooth-transition">Обновить</button>
      </div>
    </div>
  </div>

  <div id="tabContent-profile" class="tabContent px-4 mt-12 pb-16 hidden">
    <div class="bg-gray-100 rounded-lg p-4 mb-4 flex items-center">
      <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center text-white text-2xl font-bold mr-4" id="profileAvatar">
        П
      </div>
      <div>
        <div id="profileName" class="text-lg font-semibold">Пользователь</div>
        <div id="profileUsername" class="text-sm text-gray-600"></div>
        <div id="profileRating" class="flex items-center mt-1">
          <div class="flex text-yellow-400 text-sm" id="ratingStars">
            <ion-icon name="star"></ion-icon>
            <ion-icon name="star"></ion-icon>
            <ion-icon name="star"></ion-icon>
            <ion-icon name="star"></ion-icon>
            <ion-icon name="star-half"></ion-icon>
          </div>
          <span class="text-xs text-gray-500 ml-1" id="ratingText">4.8 (12 отзывов)</span>
        </div>
      </div>
    </div>
    <div id="walletSection" class="mb-4">
      <button id="connectWalletBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg w-full flex items-center justify-center smooth-transition">
        <ion-icon name="wallet-outline" class="text-xl mr-2"></ion-icon>
        <span>Подключить TON кошелек</span>
      </button>
      <div id="walletInfo" class="hidden p-4 bg-gray-100 rounded-lg mt-2">
        <div class="flex justify-between items-center mb-2">
          <div class="text-sm font-medium text-gray-700">TON Кошелек</div>
          <button id="disconnectWalletBtn" class="text-blue-500 text-sm hover:text-blue-700 smooth-transition">Отключить</button>
        </div>
        <div id="walletAddress" class="text-xs text-gray-500 break-all bg-white p-2 rounded mb-3"></div>
        <div class="flex justify-between items-center">
          <div class="text-sm font-medium text-gray-700">Баланс</div>
          <div id="walletBalance" class="font-semibold">0 TON</div>
        </div>
      </div>
      <button id="topUpBalanceBtn" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md mt-2">
        Пополнить баланс
      </button>
    </div>
    <div class="flex justify-around mt-4">
      <button id="settingsBtn" class="px-4 py-2 bg-gray-200 rounded-md">Настройки</button>
      <button id="helpBtn" class="px-4 py-2 bg-gray-200 rounded-md">Помощь</button>
      <button id="aboutBtn" class="px-4 py-2 bg-gray-200 rounded-md">О приложении</button>
    </div>
    <button id="editProfileBtn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-md mt-4">
      Редактировать профиль
    </button>
    <div class="grid grid-cols-2 gap-3 mt-4">
      <div class="bg-blue-50 p-3 rounded-lg">
        <div class="text-xs text-blue-600 mb-1">Завершено заказов</div>
        <div class="text-xl font-semibold" id="completedOrders">0</div>
      </div>
      <div class="bg-green-50 p-3 rounded-lg">
        <div class="text-xs text-green-600 mb-1">Заработано</div>
        <div class="text-xl font-semibold" id="earnedAmount">0 TON</div>
      </div>
      <div class="bg-purple-50 p-3 rounded-lg">
        <div class="text-xs text-purple-600 mb-1">Шаблонов продано</div>
        <div class="text-xl font-semibold" id="templatesSold">0</div>
      </div>
      <div class="bg-yellow-50 p-3 rounded-lg">
        <div class="text-xs text-yellow-600 mb-1">Рейтинг</div>
        <div class="text-xl font-semibold" id="userRating">0</div>
      </div>
    </div>
    <div>
      <h3 class="font-medium mb-2">История операций</h3>
      <ul class="text-sm text-gray-700 space-y-3" id="historyList"></ul>
      <button id="loadMoreHistory" class="w-full text-center text-blue-500 text-sm py-2 hover:text-blue-700 smooth-transition hidden">
        Показать еще
      </button>
    </div>
  </div>

  <!-- Bottom Nav Bar -->
  <div id="bottomNav" class="fixed bottom-0 left-0 w-full h-14 border-t bg-white flex justify-around items-center z-10 shadow-sm">
    <button id="tab-articles" class="flex flex-col items-center justify-center flex-1 h-full smooth-transition">
      <ion-icon id="tab-icon-articles" name="document-text-outline" class="text-2xl text-gray-600 mb-1"></ion-icon>
      <span class="text-xs text-gray-600">Статьи</span>
    </button>
    <button id="tab-market" class="flex flex-col items-center justify-center flex-1 h-full smooth-transition">
      <ion-icon id="tab-icon-market" name="pricetag-outline" class="text-2xl text-gray-600 mb-1"></ion-icon>
      <span class="text-xs text-gray-600">Маркет</span>
    </button>
    <button id="tab-requests" class="flex flex-col items-center justify-center flex-1 h-full smooth-transition">
      <ion-icon id="tab-icon-requests" name="clipboard-outline" class="text-2xl text-blue-600 mb-1"></ion-icon>
      <span class="text-xs text-blue-600">Заявки</span>
    </button>
    <button id="tab-profile" class="flex flex-col items-center justify-center flex-1 h-full smooth-transition">
      <ion-icon id="tab-icon-profile" name="person-outline" class="text-2xl text-gray-600 mb-1"></ion-icon>
      <span class="text-xs text-gray-600">Профиль</span>
    </button>
  </div>

  <!-- Chat Overlay -->
  <div id="chatOverlay" class="hidden fixed inset-0 z-50 flex flex-col bg-white">
    <div class="h-12 flex items-center border-b px-4 bg-white sticky top-0 z-10">
      <button id="closeChatBtn" class="mr-2">
        <ion-icon name="chevron-back-outline" class="text-2xl text-blue-600"></ion-icon>
      </button>
      <div class="flex-1 font-medium truncate" id="chatRequestTitle">Заявка</div>
      <button id="chatRequestActionBtn" class="text-blue-600 text-sm font-medium hover:text-blue-800 smooth-transition"></button>
    </div>
    <div id="chatMessages" class="flex-1 overflow-y-auto px-4 py-2 space-y-3"></div>
    <div class="border-t p-3 flex items-center bg-white sticky bottom-0">
      <div class="relative">
        <button id="attachFileBtn" class="text-gray-500 hover:text-gray-700 mr-2 smooth-transition">
          <ion-icon name="attach-outline" class="text-xl"></ion-icon>
        </button>
        <div id="attachmentOptions" class="hidden absolute bottom-full left-0 mb-2 w-48 bg-white rounded-lg shadow-lg p-2 z-20">
          <button class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded-lg smooth-transition">
            <ion-icon name="image-outline" class="mr-2"></ion-icon> Фото
          </button>
          <button class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded-lg smooth-transition">
            <ion-icon name="document-outline" class="mr-2"></ion-icon> Файл
          </button>
          <button class="w-full text-left px-3 py-2 text-sm hover:bg-gray-100 rounded-lg smooth-transition">
            <ion-icon name="location-outline" class="mr-2"></ion-icon> Местоположение
          </button>
        </div>
      </div>
      <input id="chatInput" type="text" class="flex-1 border border-gray-300 rounded-full px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent smooth-transition" placeholder="Написать сообщение..." />
      <button id="chatSendBtn" class="ml-2 text-blue-600 font-semibold text-sm hover:text-blue-800 smooth-transition">Отправить</button>
    </div>
  </div>

  <!-- Модальное окно авторизации через Telegram -->
  <div id="loginModal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg w-full max-w-sm p-6 slide-up">
      <div class="flex justify-center items-center mb-4">
        <h3 class="text-lg font-semibold">Вход через Telegram</h3>
      </div>
      <!-- Только Telegram-виджет -->
      <div class="flex justify-center">
        <!-- Замените "your_bot_username" на имя вашего Telegram-бота (без "@"!) -->
        <script async src="https://telegram.org/js/telegram-widget.js?7"
                data-telegram-login="your_bot_username"
                data-size="large"
                data-userpic="false"
                data-request-access="write"
                data-onauth="onTelegramAuth(user)">
        </script>
      </div>
      <p class="text-xs text-gray-500 text-center mt-4">
        После авторизации через Telegram вы получите доступ к приложению.
      </p>
    </div>
  </div>

  <!-- Загрузочный оверлей -->
  <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div id="loadingMessage" class="text-white text-lg"></div>
  </div>

  <!-- Основной скрипт -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // Удаляем переменные авто-регистрации, так как используется только Telegram
      // const autoUserId = "{{USER_ID_TEXT}}";
      // const autoUsername = "{{USERNAME_TEXT}}";
      // const autoAvatarUrl = "{{USER_AVATAR_URL}}";

      // Инициализация Supabase – замените ключ на ваш реальный
      const supabaseUrl = 'https://kwwszbvcwchujbyvswqp.supabase.co';
      const supabaseKey = 'YOUR_SUPABASE_KEY';
      const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

      // Определение вкладок и иконок (оставлено без изменений)
      const tabTitles = { articles: 'Статьи', market: 'Маркет', requests: 'Заявки', profile: 'Профиль' };
      const tabIcons = {
        articles: { outline: 'document-text-outline', filled: 'document-text' },
        market: { outline: 'pricetag-outline', filled: 'pricetag' },
        requests: { outline: 'clipboard-outline', filled: 'clipboard' },
        profile: { outline: 'person-outline', filled: 'person' }
      };

      // Состояние приложения
      const state = {
        currentTab: 'requests',
        currentRole: 'customer',
        currentUser: null,
        walletConnected: false,
        currentChatRequestId: null,
        chatMessages: [],
        theme: 'light',
        notifications: { messages: true, requests: true, news: false },
        language: 'ru',
        historyItems: [],
        articles: [],
        templates: [],
        requests: [],
        isLoading: false,
        currentArticleId: null,
        currentTemplateId: null,
        currentRequestId: null,
        historyPage: 1,
        historyPerPage: 5,
        pendingAction: null,
        pendingActionData: null,
        selectedFiles: [],
        selectedTemplateFile: null,
        selectedTemplatePreview: null,
        articlesCache: null,
        articlesCacheTimestamp: null
      };

      // Универсальный обработчик для кликов и касаний
      function bindEvent(element, eventName, handler) {
        if (element) {
          element.addEventListener(eventName, handler);
          if ('ontouchstart' in window && eventName === 'click') {
            element.addEventListener('touchend', (e) => {
              e.preventDefault();
              handler(e);
            });
          }
        }
      }

      // Функция debounce
      function debounce(func, delay = 300) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), delay);
        };
      }

      // Retry механизм
      async function executeWithRetry(fn, retries = 2, delay = 500) {
        for (let i = 0; i <= retries; i++) {
          try {
            return await fn();
          } catch (error) {
            if (i === retries) throw error;
            await new Promise(res => setTimeout(res, delay));
          }
        }
      }

      // Периодическое обновление уведомлений каждые 30 секунд
      setInterval(() => {
        if (state.currentUser) loadNotifications();
      }, 30000);

      initApp();
      setupEventListeners();

      async function initApp() {
        try {
          const isAuthorized = await checkAuth();
          if (!isAuthorized) throw new Error('Пользователь не авторизован');
          switchTab(state.currentTab);
          await loadInitialData();
          initTheme();
          initLanguage();
          initNotifications();
        } catch (error) {
          console.error('App initialization failed:', error);
          showToast('Не удалось загрузить приложение', 'error');
        }
      }

      async function checkAuth() {
        try {
          const { data: { user }, error } = await supabaseClient.auth.getUser();
          if (error) throw error;
          if (user) {
            state.currentUser = user;
            await loadUserProfile(user.id);
            return true;
          } else {
            showLoginModal();
            return false;
          }
        } catch (error) {
          console.error('Error checking auth:', error);
          showLoginModal();
          return false;
        }
      }

      // Убираем авто-регистрацию, оставляем только Telegram
      // Функция, вызываемая Telegram-виджетом после авторизации.
      // Объект user содержит: id, first_name, last_name, username, photo_url, auth_date, hash.
      function onTelegramAuth(user) {
        console.log("Telegram auth data:", user);
        // Здесь обязательно нужно выполнить серверную проверку полученного hash (не реализовано в этом примере).
        // Формируем фиктивный email на основе id Telegram
        const dummyEmail = `telegram${user.id}@example.com`;
        const dummyPassword = Math.random().toString(36).substring(2, 10);
        registerTelegramUser(dummyEmail, dummyPassword, user);
      }

      // Регистрация/вход через Supabase с данными Telegram
      async function registerTelegramUser(email, password, telegramData) {
        try {
          showLoading("Авторизация через Telegram...");
          // Пробуем зарегистрировать пользователя
          const { data, error } = await supabaseClient.auth.signUp({
            email: email,
            password: password
          });
          if (error) {
            // Если регистрация не проходит (пользователь уже существует) – выполняем вход
            const { data: loginData, error: loginError } = await supabaseClient.auth.signInWithPassword({
              email: email,
              password: password
            });
            if (loginError) throw loginError;
            state.currentUser = loginData.user;
          } else {
            state.currentUser = data.user;
          }
          // Записываем или обновляем данные в таблице users
          const { error: profileError } = await supabaseClient.from('users').upsert({
            id: state.currentUser.id,
            username: telegramData.username || telegramData.first_name,
            avatar_url: telegramData.photo_url || '',
            role: 'customer'
          });
          if (profileError) throw profileError;
          hideLoading();
          closeLoginModal();
          showToast("Вы успешно вошли через Telegram", "success");
          initApp();
        } catch (err) {
          hideLoading();
          console.error("Ошибка авторизации через Telegram:", err);
          showToast("Ошибка авторизации через Telegram: " + err.message, "error");
        }
      }

      async function loadUserProfile(userId) {
        try {
          const { data, error } = await supabaseClient.from('users').select('*').eq('id', userId).single();
          if (error) throw error;
          if (data) {
            state.currentUser.profile = data;
            updateProfileUI(data);
            await loadUserWallet(userId);
            if (data.role) {
              state.currentRole = data.role;
              updateRoleUI();
            }
            await loadUserStats(userId);
          }
        } catch (error) {
          console.error('Error loading user profile:', error);
          showToast('Ошибка загрузки профиля', 'error');
        }
      }

      async function loadUserWallet(userId) {
        try {
          const { data, error } = await supabaseClient.from('wallets').select('*').eq('user_id', userId).single();
          if (error) throw error;
          if (data) {
            state.walletConnected = true;
            updateWalletUI(data);
          }
        } catch (error) {
          console.error('Error loading wallet:', error);
          showToast('Ошибка загрузки кошелька', 'error');
        }
      }

      async function loadUserStats(userId) {
        try {
          const { data, error } = await supabaseClient.from('user_stats').select('*').eq('user_id', userId).single();
          if (error) throw error;
          if (data) {
            updateUserStatsUI(data);
          }
        } catch (error) {
          console.error('Error loading user stats:', error);
        }
      }

      function updateProfileUI(profile) {
        if (profile.first_name) {
          const name = `${profile.first_name}${profile.last_name ? ' ' + profile.last_name : ''}`;
          document.getElementById('profileName').textContent = name;
          document.getElementById('profileAvatar').textContent = profile.first_name[0].toUpperCase();
        }
        if (profile.username) {
          document.getElementById('profileUsername').textContent = `@${profile.username}`;
        }
        if (profile.rating) {
          updateRatingUI(profile.rating);
        }
      }

      function updateUserStatsUI(stats) {
        document.getElementById('completedOrders').textContent = stats.completed_orders || 0;
        document.getElementById('earnedAmount').textContent = `${stats.earned_amount || 0} TON`;
        document.getElementById('templatesSold').textContent = stats.templates_sold || 0;
        document.getElementById('userRating').textContent = stats.rating ? stats.rating.toFixed(1) : 0;
      }

      function updateRatingUI(rating) {
        const starsContainer = document.getElementById('ratingStars');
        starsContainer.innerHTML = '';
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        for (let i = 0; i < fullStars; i++) {
          const star = document.createElement('ion-icon');
          star.setAttribute('name', 'star');
          starsContainer.appendChild(star);
        }
        if (hasHalfStar) {
          const halfStar = document.createElement('ion-icon');
          halfStar.setAttribute('name', 'star-half');
          starsContainer.appendChild(halfStar);
        }
        const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
        for (let i = 0; i < emptyStars; i++) {
          const emptyStar = document.createElement('ion-icon');
          emptyStar.setAttribute('name', 'star-outline');
          starsContainer.appendChild(emptyStar);
        }
        document.getElementById('ratingText').textContent = `${rating.toFixed(1)} (${state.currentUser.profile.reviews_count || 0} отзывов)`;
      }

      function updateWalletUI(wallet) {
        document.getElementById('walletAddress').textContent = wallet.address;
        document.getElementById('walletBalance').textContent = `${wallet.balance} ${wallet.currency}`;
        document.getElementById('connectWalletBtn').classList.add('hidden');
        document.getElementById('walletInfo').classList.remove('hidden');
      }

      function updateRoleUI() {
        if (state.currentRole === 'customer') {
          document.getElementById('roleCustBtn')?.classList.add('bg-blue-500', 'text-white');
          document.getElementById('roleCustBtn')?.classList.remove('text-blue-500');
          document.getElementById('roleDevBtn')?.classList.add('text-blue-500');
          document.getElementById('roleDevBtn')?.classList.remove('bg-blue-500', 'text-white');
        } else {
          document.getElementById('roleDevBtn')?.classList.add('bg-blue-500', 'text-white');
          document.getElementById('roleDevBtn')?.classList.remove('text-blue-500');
          document.getElementById('roleCustBtn')?.classList.add('text-blue-500');
          document.getElementById('roleCustBtn')?.classList.remove('bg-blue-500', 'text-white');
        }
        document.getElementById('addTemplateCard').classList.toggle('hidden', state.currentRole !== 'developer');
        document.getElementById('customerRequests').classList.toggle('hidden', state.currentRole !== 'customer');
        document.getElementById('developerRequests').classList.toggle('hidden', state.currentRole === 'customer');
      }

      async function loadInitialData() {
        showLoading('Загрузка данных...');
        try {
          await Promise.all([
            loadArticles(),
            loadTemplates(),
            loadRequests(),
            loadNotifications(),
            loadHistory()
          ]);
        } catch (error) {
          console.error('Error loading initial data:', error);
          showToast('Ошибка загрузки данных', 'error');
        } finally {
          hideLoading();
        }
      }

      async function loadArticles() {
        const cacheDuration = 5 * 60 * 1000;
        const now = new Date().getTime();
        if (state.articlesCache && state.articlesCacheTimestamp && now - state.articlesCacheTimestamp < cacheDuration) {
          state.articles = state.articlesCache;
          renderArticles();
          return;
        }
        try {
          const fetchArticles = async () => await supabaseClient.from('articles').select('*').order('created_at', { ascending: false });
          const { data, error } = await executeWithRetry(fetchArticles, 2, 500);
          if (error) throw error;
          if (data) {
            state.articles = data;
            state.articlesCache = data;
            state.articlesCacheTimestamp = new Date().getTime();
            renderArticles();
          }
        } catch (error) {
          console.error('Error loading articles:', error);
          showToast('Ошибка загрузки статей', 'error');
        }
      }

      function renderArticles() {
        const articlesList = document.getElementById('articlesList');
        articlesList.innerHTML = '';
        if (state.articles.length === 0) {
          articlesList.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <ion-icon name="document-text-outline" class="text-3xl mb-2"></ion-icon>
              <p>Статьи не найдены</p>
            </div>
          `;
          return;
        }
        state.articles.forEach(article => {
          const articleEl = document.createElement('div');
          articleEl.className = 'flex justify-between items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 smooth-transition';
          articleEl.onclick = () => openArticle(article.id);
          articleEl.innerHTML = `
            <div class="flex items-start">
              <div class="bg-blue-100 p-2 rounded-lg mr-3">
                <ion-icon name="document-text-outline" class="text-blue-600 text-xl"></ion-icon>
              </div>
              <div>
                <div class="font-medium">${article.title}</div>
                <div class="text-xs text-gray-500 mt-1">${article.description}</div>
                <div class="flex items-center mt-2 text-xs text-gray-400">
                  <ion-icon name="time-outline" class="mr-1"></ion-icon>
                  <span>${article.reading_time || 5} мин чтения</span>
                </div>
              </div>
            </div>
            <ion-icon name="chevron-forward-outline" class="text-gray-400 text-xl"></ion-icon>
          `;
          articlesList.appendChild(articleEl);
        });
      }

      async function loadTemplates(filters = {}) {
        try {
          let query = supabaseClient.from('templates').select('*').eq('status', 'approved').order('created_at', { ascending: false });
          if (filters.category && filters.category !== 'all') {
            query = query.eq('category', filters.category);
          }
          if (filters.price && filters.price !== 'all') {
            const [min, max] = filters.price.split('-');
            if (max) { query = query.gte('price', parseFloat(min)).lte('price', parseFloat(max)); }
            else { query = query.gte('price', parseFloat(min.replace('+', ''))); }
          }
          const { data, error } = await query;
          if (error) throw error;
          if (data) { state.templates = data; renderTemplates(); }
        } catch (error) {
          console.error('Error loading templates:', error);
          showToast('Ошибка загрузки шаблонов', 'error');
        }
      }

      function renderTemplates() {
        const templatesList = document.getElementById('templatesList');
        templatesList.innerHTML = '';
        if (state.templates.length === 0) {
          document.getElementById('noTemplatesMessage').classList.remove('hidden');
          return;
        }
        document.getElementById('noTemplatesMessage').classList.add('hidden');
        state.templates.forEach(template => {
          const templateEl = document.createElement('div');
          templateEl.className = 'relative border rounded-lg p-4 hover:shadow-md smooth-transition';
          templateEl.innerHTML = `
            <div class="flex items-start">
              <div class="w-16 h-16 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                <ion-icon name="cube-outline" class="text-purple-600 text-2xl"></ion-icon>
              </div>
              <div class="flex-1">
                <div class="font-medium">${template.title}</div>
                <div class="text-sm text-gray-500 mt-1">${template.description}</div>
                ${template.rating > 0 ? `
                  <div class="flex items-center mt-2">
                    <div class="flex text-yellow-400 text-sm">
                      ${renderStarsHTML(template.rating)}
                    </div>
                    <span class="text-xs text-gray-500 ml-1">${template.rating.toFixed(1)} (${template.reviews_count})</span>
                  </div>
                ` : ''}
              </div>
            </div>
            <div class="flex justify-between items-center mt-3 pt-3 border-t">
              <div>
                <div class="text-sm font-semibold text-gray-700">${template.price} TON</div>
                <div class="text-xs text-gray-500">${template.sales_count} продаж</div>
              </div>
              <button class="bg-blue-500 hover:bg-blue-600 text-white text-sm px-4 py-2 rounded-lg smooth-transition">
                Купить
              </button>
            </div>
          `;
          templatesList.appendChild(templateEl);
        });
      }

      function renderStarsHTML(rating) {
        let stars = '';
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        for (let i = 0; i < fullStars; i++) { stars += '<ion-icon name="star"></ion-icon>'; }
        if (hasHalfStar) { stars += '<ion-icon name="star-half"></ion-icon>'; }
        const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
        for (let i = 0; i < emptyStars; i++) { stars += '<ion-icon name="star-outline"></ion-icon>'; }
        return stars;
      }

      async function loadRequests(filters = {}) {
        if (state.currentRole === 'customer') { await loadCustomerRequests(filters); }
        else { await loadDeveloperRequests(filters); }
      }

      async function loadCustomerRequests(filters = {}) {
        if (!state.currentUser) return;
        try {
          let query = supabaseClient.from('requests').select('*').eq('customer_id', state.currentUser.id).order('created_at', { ascending: false });
          if (filters.status && filters.status !== 'all') { query = query.eq('status', filters.status); }
          const { data, error } = await query;
          if (error) throw error;
          if (data) { state.requests = data; renderCustomerRequests(); }
        } catch (error) {
          console.error('Error loading customer requests:', error);
          showToast('Ошибка загрузки заявок', 'error');
        }
      }

      function renderCustomerRequests() {
        const requestsList = document.getElementById('customerRequestsList');
        requestsList.innerHTML = '';
        if (state.requests.length === 0) { document.getElementById('noCustomerRequests').classList.remove('hidden'); return; }
        document.getElementById('noCustomerRequests').classList.add('hidden');
        state.requests.forEach(request => {
          const requestEl = document.createElement('div');
          requestEl.className = 'border rounded-lg p-4 hover:shadow-md smooth-transition cursor-pointer';
          requestEl.onclick = () => openRequestChat(request.id);
          let statusBadge = '';
          if (request.status === 'open') { statusBadge = 'bg-orange-100 text-orange-800'; }
          else if (request.status === 'in_progress') { statusBadge = 'bg-blue-100 text-blue-800'; }
          else if (request.status === 'completed') { statusBadge = 'bg-green-100 text-green-800'; }
          else if (request.status === 'cancelled') { statusBadge = 'bg-gray-100 text-gray-800'; }
          requestEl.innerHTML = `
            <div class="flex justify-between items-start">
              <div>
                <div class="font-medium">${request.title}</div>
                <div class="text-sm text-gray-500 mt-1">Бюджет: ${request.budget} TON</div>
              </div>
              <div class="${statusBadge} text-xs px-2 py-1 rounded-full">${getStatusText(request.status)}</div>
            </div>
            ${request.developer_id ? `
              <div class="flex items-center mt-3 pt-3 border-t">
                <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center mr-2">
                  <ion-icon name="person-outline" class="text-gray-600"></ion-icon>
                </div>
                <div class="text-sm text-gray-700">Исполнитель: ${request.developer_id}</div>
              </div>
            ` : `
              <div class="flex items-center mt-3 pt-3 border-t">
                <div class="text-sm text-gray-500">${request.responses_count || 0} откликов</div>
              </div>
            `}
            <div class="flex items-center mt-2 text-sm text-gray-500">
              <ion-icon name="time-outline" class="mr-1"></ion-icon>
              <span>Обновлено ${formatDate(request.updated_at)}</span>
            </div>
          `;
          requestsList.appendChild(requestEl);
        });
      }

      async function loadDeveloperRequests(filters = {}) {
        try {
          let query = supabaseClient.from('requests').select('*, customers:users(*)').eq('status', 'open').order('created_at', { ascending: false });
          if (filters.budget && filters.budget !== 'all') {
            const [min, max] = filters.budget.split('-');
            if (max) { query = query.gte('budget', parseFloat(min)).lte('budget', parseFloat(max)); }
            else { query = query.gte('budget', parseFloat(min.replace('+', ''))); }
          }
          if (filters.deadline && filters.deadline !== 'all') {
            const [min, max] = filters.deadline.split('-');
            if (max) { query = query.gte('deadline', parseInt(min)).lte('deadline', parseInt(max)); }
            else { query = query.gte('deadline', parseInt(min.replace('+', ''))); }
          }
          const { data, error } = await query;
          if (error) throw error;
          if (data) { state.requests = data; renderDeveloperRequests(); }
        } catch (error) {
          console.error('Error loading developer requests:', error);
          showToast('Ошибка загрузки заявок', 'error');
        }
      }

      function renderDeveloperRequests() {
        const requestsList = document.getElementById('developerRequestsList');
        requestsList.innerHTML = '';
        if (state.requests.length === 0) { document.getElementById('noDeveloperRequests').classList.remove('hidden'); return; }
        document.getElementById('noDeveloperRequests').classList.add('hidden');
        state.requests.forEach(request => {
          const requestEl = document.createElement('div');
          requestEl.className = 'border rounded-lg p-4 hover:shadow-md smooth-transition cursor-pointer';
          requestEl.onclick = () => openRequestChat(request.id);
          const customer = request.customers;
          requestEl.innerHTML = `
            <div class="flex justify-between items-start">
              <div>
                <div class="font-medium">${request.title}</div>
                <div class="text-sm text-gray-500 mt-1">Бюджет: ${request.budget} TON</div>
              </div>
              <div class="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full">${getStatusText(request.status)}</div>
            </div>
            <div class="flex items-center mt-3 pt-3 border-t">
              <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center mr-2">
                <ion-icon name="person-outline" class="text-gray-600"></ion-icon>
              </div>
              <div class="text-sm text-gray-700">${customer.first_name} ${customer.last_name || ''}</div>
            </div>
            <div class="flex items-center mt-2 text-sm text-gray-500">
              <ion-icon name="time-outline" class="mr-1"></ion-icon>
              <span>Опубликовано ${formatDate(request.created_at)}</span>
            </div>
            <button class="mt-3 w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg smooth-transition">
              Откликнуться
            </button>
          `;
          requestsList.appendChild(requestEl);
        });
      }

      function getStatusText(status) {
        const statusTexts = { open: 'Открыта', in_progress: 'В работе', completed: 'Завершена', cancelled: 'Отменена' };
        return statusTexts[status] || status;
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;
        const diffDays = Math.floor(diff / (1000 * 60 * 60 * 24));
        if (diffDays === 0) { return 'сегодня'; }
        else if (diffDays === 1) { return 'вчера'; }
        else if (diffDays < 7) { return `${diffDays} дня назад`; }
        else { return date.toLocaleDateString('ru-RU'); }
      }

      async function loadNotifications() {
        if (!state.currentUser) return;
        try {
          const { data, error } = await supabaseClient.from('notifications').select('*').eq('user_id', state.currentUser.id).eq('is_read', false).order('created_at', { ascending: false });
          if (error) throw error;
          if (data && data.length > 0) {
            document.getElementById('notifDot').classList.remove('hidden');
            renderNotifications(data);
          }
        } catch (error) {
          console.error('Error loading notifications:', error);
        }
      }

      function renderNotifications(notifications) {
        const notificationsList = document.getElementById('notificationsList');
        notificationsList.innerHTML = '';
        notifications.forEach(notification => {
          const notificationEl = document.createElement('div');
          notificationEl.className = 'flex items-start p-2 rounded-lg hover:bg-gray-50 smooth-transition';
          let iconName = 'information-circle-outline';
          let iconColor = 'blue';
          if (notification.type === 'request') { iconName = 'chatbubble-ellipses-outline'; iconColor = 'blue'; }
          else if (notification.type === 'template') { iconName = 'checkmark-circle-outline'; iconColor = 'green'; }
          else if (notification.type === 'payment') { iconName = 'cash-outline'; iconColor = 'green'; }
          notificationEl.innerHTML = `
            <ion-icon name="${iconName}" class="text-${iconColor}-500 text-lg mr-2 mt-0.5 flex-shrink-0"></ion-icon>
            <div class="text-sm">${notification.message}</div>
          `;
          notificationsList.appendChild(notificationEl);
        });
      }

      async function loadHistory() {
        if (!state.currentUser) return;
        try {
          const { data, error } = await supabaseClient.from('transactions').select('*').eq('user_id', state.currentUser.id).order('created_at', { ascending: false }).range(0, state.historyPerPage - 1);
          if (error) throw error;
          if (data) { state.historyItems = data; renderHistory(); }
        } catch (error) {
          console.error('Error loading history:', error);
          showToast('Ошибка загрузки истории', 'error');
        }
      }

      async function loadMoreHistory() {
        if (!state.currentUser) return;
        showLoading('Загрузка дополнительных записей...');
        try {
          const nextPage = state.historyPage + 1;
          const start = (nextPage - 1) * state.historyPerPage;
          const end = nextPage * state.historyPerPage - 1;
          const { data, error } = await supabaseClient.from('transactions').select('*').eq('user_id', state.currentUser.id).order('created_at', { ascending: false }).range(start, end);
          if (error) throw error;
          if (data && data.length > 0) { state.historyItems = [...state.historyItems, ...data]; state.historyPage = nextPage; renderHistory(); }
          else { document.getElementById('loadMoreHistory').classList.add('hidden'); }
        } catch (error) {
          console.error('Error loading more history:', error);
          showToast('Ошибка загрузки истории', 'error');
        } finally { hideLoading(); }
      }

      function renderHistory() {
        const historyList = document.getElementById('historyList');
        historyList.innerHTML = '';
        state.historyItems.forEach(item => {
          const historyItem = document.createElement('li');
          historyItem.className = 'flex justify-between items-start';
          let iconName = 'cash-outline';
          let iconColor = 'blue';
          if (item.type === 'purchase') { iconName = 'pricetag-outline'; iconColor = 'purple'; }
          else if (item.type === 'sale') { iconName = 'cash-outline'; iconColor = 'green'; }
          else if (item.type === 'transfer') { iconName = 'swap-horizontal-outline'; iconColor = 'blue'; }
          else if (item.type === 'withdrawal') { iconName = 'arrow-down-outline'; iconColor = 'red'; }
          else if (item.type === 'deposit') { iconName = 'arrow-up-outline'; iconColor = 'green'; }
          const amountEl = item.amount > 0 ? `<div class="text-green-500 font-medium">+${item.amount} ${item.currency}</div>` : `<div class="text-red-500 font-medium">${item.amount} ${item.currency}</div>`;
          historyItem.innerHTML = `
            <div class="flex items-start">
              <div class="bg-${iconColor}-100 p-1 rounded mr-2">
                <ion-icon name="${iconName}" class="text-${iconColor}-600"></ion-icon>
              </div>
              <div>
                <div>${item.description}</div>
                <div class="text-xs text-gray-400">${formatDate(item.created_at)}</div>
              </div>
            </div>
            ${amountEl}
          `;
          historyList.appendChild(historyItem);
        });
        if (state.historyItems.length >= state.historyPerPage) { document.getElementById('loadMoreHistory').classList.remove('hidden'); }
      }

      async function openArticle(articleId) {
        showLoading('Загрузка статьи...');
        try {
          const { data, error } = await supabaseClient.from('articles').select('*').eq('id', articleId).single();
          if (error) throw error;
          if (data) {
            state.currentArticleId = articleId;
            showToast(`Открыта статья: ${data.title}`, 'info');
          }
        } catch (error) {
          console.error('Error opening article:', error);
          showToast('Ошибка загрузки статьи', 'error');
        } finally { hideLoading(); }
      }

      // Чат: подписка на новые сообщения в реальном времени
      let chatSubscription = null;
      function subscribeToChat(requestId) {
        if (!requestId) return;
        const subscription = supabaseClient
          .from(`chat_messages:request_id=eq.${requestId}`)
          .on('INSERT', payload => {
            console.log("Новое сообщение:", payload.new);
            state.chatMessages.push(payload.new);
            renderChatMessages();
          })
          .subscribe();
        return subscription;
      }
      const originalOpenRequestChat = openRequestChat;
      async function openRequestChat(requestId) {
        if (chatSubscription) {
          supabaseClient.removeSubscription(chatSubscription);
        }
        await originalOpenRequestChat(requestId);
        chatSubscription = subscribeToChat(requestId);
      }
      const originalCloseChat = closeChat;
      function closeChat() {
        if (chatSubscription) {
          supabaseClient.removeSubscription(chatSubscription);
          chatSubscription = null;
        }
        originalCloseChat();
      }

      async function respondToRequest(requestId) {
        showLoading('Отправка отклика...');
        try {
          const { data, error } = await supabaseClient.from('request_responses').insert([{ request_id: requestId, developer_id: state.currentUser.id, message: 'Я готов выполнить эту работу', price: state.requests.find(r => r.id === requestId).budget }]);
          if (error) throw error;
          if (data) { showToast('Ваш отклик отправлен', 'success'); await loadRequests(); }
        } catch (error) {
          console.error('Error responding to request:', error);
          showToast('Ошибка отправки отклика', 'error');
        } finally { hideLoading(); }
      }

      async function completeRequest(requestId) {
        showConfirmation(
          'Завершение заказа',
          'Вы уверены, что хотите завершить этот заказ? После подтверждения средства будут переведены разработчику.',
          async () => {
            showLoading('Завершение заказа...');
            try {
              const { data, error } = await supabaseClient.from('requests').update({ status: 'completed' }).eq('id', requestId);
              if (error) throw error;
              if (data) { showToast('Заказ успешно завершен', 'success'); await loadRequests(); closeChat(); }
            } catch (error) {
              console.error('Error completing request:', error);
              showToast('Ошибка завершения заказа', 'error');
            } finally { hideLoading(); }
          }
        );
      }

      function renderChatMessages() {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = '';
        state.chatMessages.forEach(msg => {
          const isCurrentUser = msg.sender_id === state.currentUser.id;
          const bubble = document.createElement('div');
          bubble.className = 'flex ' + (isCurrentUser ? 'justify-end' : 'justify-start');
          const bubbleInner = document.createElement('div');
          bubbleInner.className = 'max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ' + (isCurrentUser ? 'bg-blue-500 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-bl-none');
          if (!isCurrentUser) {
            const senderName = document.createElement('div');
            senderName.className = 'text-xs font-medium mb-1';
            senderName.textContent = msg.sender?.first_name || 'Аноним';
            bubbleInner.appendChild(senderName);
          }
          const messageContent = document.createElement('div');
          messageContent.textContent = msg.message;
          bubbleInner.appendChild(messageContent);
          const timestamp = document.createElement('div');
          timestamp.className = 'text-xs mt-1 text-right ' + (isCurrentUser ? 'text-blue-100' : 'text-gray-500');
          timestamp.textContent = formatTime(msg.created_at);
          bubbleInner.appendChild(timestamp);
          bubble.appendChild(bubbleInner);
          chatMessages.appendChild(bubble);
        });
        setTimeout(() => { chatMessages.scrollTop = chatMessages.scrollHeight; }, 10);
      }

      function formatTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      }

      function closeChat() {
        document.getElementById('chatOverlay').classList.add('hidden');
        state.currentRequestId = null;
        state.chatMessages = [];
      }

      async function sendMessage() {
        const text = document.getElementById('chatInput').value.trim();
        if (!text || !state.currentRequestId || !state.currentUser) return;
        showLoading('Отправка сообщения...');
        try {
          const { data, error } = await supabaseClient.from('chat_messages').insert([{ request_id: state.currentRequestId, sender_id: state.currentUser.id, message: text }]);
          if (error) throw error;
          if (data) { document.getElementById('chatInput').value = ''; await openRequestChat(state.currentRequestId); }
        } catch (error) {
          console.error('Error sending message:', error);
          showToast('Ошибка отправки сообщения', 'error');
        } finally { hideLoading(); }
      }

      async function connectWallet() {
        if (!state.currentUser) return;
        showConfirmation(
          'Подключение кошелька',
          'Вы хотите подключить TON кошелек к вашему аккаунту?',
          async () => {
            showLoading('Подключение кошелька...');
            try {
              const dummyAddress = 'EQC' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
              const { data, error } = await supabaseClient.from('wallets').upsert([{ user_id: state.currentUser.id, address: dummyAddress, balance: 100, currency: 'TON' }], { onConflict: 'user_id' });
              if (error) throw error;
              if (data) {
                state.walletConnected = true;
                updateWalletUI({ address: dummyAddress, balance: 100, currency: 'TON' });
                await supabaseClient.from('transactions').insert([{ user_id: state.currentUser.id, amount: 100, currency: 'TON', type: 'deposit', description: 'Пополнение баланса' }]);
                showToast('TON кошелек успешно подключен', 'success');
              }
            } catch (error) {
              console.error('Error connecting wallet:', error);
              showToast('Ошибка подключения кошелька', 'error');
            } finally { hideLoading(); }
          }
        );
      }

      async function disconnectWallet() {
        showConfirmation(
          'Отключение кошелька',
          'Вы уверены, что хотите отключить TON кошелек?',
          async () => {
            showLoading('Отключение кошелька...');
            try {
              document.getElementById('connectWalletBtn').classList.remove('hidden');
              document.getElementById('walletInfo').classList.add('hidden');
              state.walletConnected = false;
              showToast('TON кошелек отключен', 'info');
            } catch (error) {
              console.error('Error disconnecting wallet:', error);
              showToast('Ошибка отключения кошелька', 'error');
            } finally { hideLoading(); }
          }
        );
      }

      function showAddRequestModal() {
        document.getElementById('requestTitle').value = '';
        document.getElementById('requestDescription').value = '';
        document.getElementById('requestBudget').value = '';
        document.getElementById('requestDeadline').value = '7';
        document.getElementById('customDeadline').value = '';
        document.getElementById('customDeadlineContainer').classList.add('hidden');
        document.getElementById('requestFiles').value = '';
        document.getElementById('requestFilesNames').classList.add('hidden');
        document.getElementById('requestFilesNames').textContent = '';
        state.selectedFiles = [];
        document.getElementById('requestTitleError').classList.add('hidden');
        document.getElementById('requestDescError').classList.add('hidden');
        document.getElementById('requestBudgetError').classList.add('hidden');
        document.getElementById('customDeadlineError').classList.add('hidden');
        document.getElementById('requestFilesError').classList.add('hidden');
        document.getElementById('addRequestModal').classList.remove('hidden');
      }

      function closeAddRequestModal() {
        document.getElementById('addRequestModal').classList.add('hidden');
      }

      function handleRequestFileUpload(event) {
        const files = event.target.files;
        if (files.length > 3) {
          document.getElementById('requestFilesError').classList.remove('hidden');
          document.getElementById('requestFilesError').textContent = 'Можно загрузить не более 3 файлов';
          return;
        }
        state.selectedFiles = Array.from(files);
        const filesNames = state.selectedFiles.map(file => file.name).join(', ');
        if (filesNames) {
          document.getElementById('requestFilesNames').textContent = filesNames;
          document.getElementById('requestFilesNames').classList.remove('hidden');
          document.getElementById('requestFilesError').classList.add('hidden');
        } else {
          document.getElementById('requestFilesNames').classList.add('hidden');
        }
      }

      async function submitNewRequest() {
        const title = document.getElementById('requestTitle').value.trim();
        const description = document.getElementById('requestDescription').value.trim();
        const budget = parseFloat(document.getElementById('requestBudget').value) || 0;
        let deadline = document.getElementById('requestDeadline').value;
        if (deadline === 'custom') { deadline = document.getElementById('customDeadline').value; }
        let isValid = true;
        if (!title) { document.getElementById('requestTitleError').classList.remove('hidden'); isValid = false; }
        else { document.getElementById('requestTitleError').classList.add('hidden'); }
        if (!description) { document.getElementById('requestDescError').classList.remove('hidden'); isValid = false; }
        else { document.getElementById('requestDescError').classList.add('hidden'); }
        if (!budget || budget <= 0) { document.getElementById('requestBudgetError').classList.remove('hidden'); isValid = false; }
        else { document.getElementById('requestBudgetError').classList.add('hidden'); }
        if (deadline === 'custom') {
          const customDeadline = document.getElementById('customDeadline').value;
          if (!customDeadline || customDeadline <= 0) { document.getElementById('customDeadlineError').classList.remove('hidden'); isValid = false; }
          else { document.getElementById('customDeadlineError').classList.add('hidden'); }
        }
        if (!isValid) { showToast('Пожалуйста, заполните все обязательные поля', 'error'); return; }
        showLoading('Создание заявки...');
        try {
          const { data, error } = await supabaseClient.from('requests').insert([{ customer_id: state.currentUser.id, title, description, budget, deadline, status: 'open' }]).select();
          if (error) throw error;
          if (data) { showToast('Заявка успешно создана', 'success'); closeAddRequestModal(); await loadRequests(); }
        } catch (error) {
          console.error('Error creating request:', error);
          showToast('Ошибка при создании заявки', 'error');
        } finally { hideLoading(); }
      }

      function showAddTemplateModal() {
        document.getElementById('templateTitle').value = '';
        document.getElementById('templateDescription').value = '';
        document.getElementById('templatePrice').value = '';
        document.getElementById('templateCategory').value = 'UI';
        document.getElementById('templateFile').value = '';
        document.getElementById('templateFileName').classList.add('hidden');
        document.getElementById('templateFileName').textContent = '';
        document.getElementById('templatePreview').value = '';
        document.getElementById('templatePreviewName').classList.add('hidden');
        document.getElementById('templatePreviewName').textContent = '';
        state.selectedTemplateFile = null;
        state.selectedTemplatePreview = null;
        document.getElementById('templateTitleError').classList.add('hidden');
        document.getElementById('templateDescError').classList.add('hidden');
        document.getElementById('templatePriceError').classList.add('hidden');
        document.getElementById('templateFileError').classList.add('hidden');
        document.getElementById('addTemplateModal').classList.remove('hidden');
      }

      function closeAddTemplateModal() {
        document.getElementById('addTemplateModal').classList.add('hidden');
      }

      function handleTemplateFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (!file.name.endsWith('.zip')) {
          document.getElementById('templateFileError').classList.remove('hidden');
          document.getElementById('templateFileError').textContent = 'Файл должен быть в формате ZIP';
          return;
        }
        state.selectedTemplateFile = file;
        document.getElementById('templateFileName').textContent = file.name;
        document.getElementById('templateFileName').classList.remove('hidden');
        document.getElementById('templateFileError').classList.add('hidden');
      }

      function handleTemplatePreviewUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (!file.type.startsWith('image/')) { showToast('Пожалуйста, загрузите изображение', 'error'); return; }
        state.selectedTemplatePreview = file;
        document.getElementById('templatePreviewName').textContent = file.name;
        document.getElementById('templatePreviewName').classList.remove('hidden');
      }

      async function submitNewTemplate() {
        const title = document.getElementById('templateTitle').value.trim();
        const description = document.getElementById('templateDescription').value.trim();
        const price = parseFloat(document.getElementById('templatePrice').value) || 0;
        const category = document.getElementById('templateCategory').value;
        let isValid = true;
        if (!title) { document.getElementById('templateTitleError').classList.remove('hidden'); isValid = false; }
        else { document.getElementById('templateTitleError').classList.add('hidden'); }
        if (!description) { document.getElementById('templateDescError').classList.remove('hidden'); isValid = false; }
        else { document.getElementById('templateDescError').classList.add('hidden'); }
        if (!price || price <= 0) { document.getElementById('templatePriceError').classList.remove('hidden'); isValid = false; }
        else { document.getElementById('templatePriceError').classList.add('hidden'); }
        if (!state.selectedTemplateFile) { document.getElementById('templateFileError').classList.remove('hidden'); isValid = false; }
        else { document.getElementById('templateFileError').classList.add('hidden'); }
        if (!isValid) { showToast('Пожалуйста, заполните все обязательные поля', 'error'); return; }
        showLoading('Отправка шаблона...');
        try {
          const { data, error } = await supabaseClient.from('templates').insert([{ developer_id: state.currentUser.id, title, description, price, category, status: 'pending' }]).select();
          if (error) throw error;
          if (data) { showToast('Шаблон успешно отправлен на модерацию', 'success'); closeAddTemplateModal(); await loadTemplates(); }
        } catch (error) {
          console.error('Error submitting template:', error);
          showToast('Ошибка при отправке шаблона', 'error');
        } finally { hideLoading(); }
      }

      function switchTab(tab) {
        if (tab === state.currentTab) return;
        document.getElementById(`tabContent-${state.currentTab}`).classList.add('hidden');
        const currentTabIcon = document.getElementById(`tab-icon-${state.currentTab}`);
        const currentTabLabel = document.querySelector(`#tab-${state.currentTab} span`);
        if (currentTabIcon && currentTabLabel) {
          currentTabIcon.setAttribute('name', tabIcons[state.currentTab].outline);
          currentTabIcon.classList.remove('text-blue-600');
          currentTabIcon.classList.add('text-gray-600');
          currentTabLabel.classList.remove('text-blue-600');
          currentTabLabel.classList.add('text-gray-600');
        }
        document.getElementById(`tabContent-${tab}`).classList.remove('hidden');
        state.currentTab = tab;
        document.getElementById('topBarTitle').textContent = tabTitles[tab] || '';
        const newTabIcon = document.getElementById(`tab-icon-${tab}`);
        const newTabLabel = document.querySelector(`#tab-${tab} span`);
        if (newTabIcon && newTabLabel) {
          newTabIcon.setAttribute('name', tabIcons[tab].filled);
          newTabIcon.classList.remove('text-gray-600');
          newTabIcon.classList.add('text-blue-600');
          newTabLabel.classList.remove('text-gray-600');
          newTabLabel.classList.add('text-blue-600');
        }
        if (tab === 'articles' && state.articles.length === 0) { loadArticles(); }
        else if (tab === 'market' && state.templates.length === 0) { loadTemplates(); }
        else if (tab === 'requests') { loadRequests(); }
        else if (tab === 'profile') { loadHistory(); }
      }

      async function switchRole(role) {
        if (role === state.currentRole) return;
        showConfirmation(
          'Смена роли',
          `Вы хотите переключиться в режим ${role === 'developer' ? 'разработчика' : 'заказчика'}?`,
          async () => {
            showLoading('Смена роли...');
            try {
              const { error } = await supabaseClient.from('users').update({ role }).eq('id', state.currentUser.id);
              if (error) throw error;
              state.currentRole = role;
              updateRoleUI();
              await loadRequests();
              showToast(`Режим ${role === 'developer' ? 'разработчика' : 'заказчика'} активирован`, 'success');
            } catch (error) {
              console.error('Error switching role:', error);
              showToast('Ошибка при смене роли', 'error');
            } finally { hideLoading(); }
          }
        );
      }

      function toggleNotifications() {
        document.getElementById('notifPanel').classList.toggle('hidden');
        if (!document.getElementById('notifPanel').classList.contains('hidden')) {
          document.getElementById('notifDot').classList.add('hidden');
          if (state.currentUser) {
            supabaseClient.from('notifications').update({ is_read: true }).eq('user_id', state.currentUser.id).eq('is_read', false);
          }
        }
      }

      async function markAllAsRead() {
        if (!state.currentUser) return;
        showLoading('Обновление уведомлений...');
        try {
          const { error } = await supabaseClient.from('notifications').update({ is_read: true }).eq('user_id', state.currentUser.id).eq('is_read', false);
          if (error) throw error;
          showToast('Все уведомления помечены как прочитанные', 'success');
          document.getElementById('notifPanel').classList.add('hidden');
          document.getElementById('notifDot').classList.add('hidden');
        } catch (error) {
          console.error('Error marking notifications as read:', error);
          showToast('Ошибка при обновлении уведомлений', 'error');
        } finally { hideLoading(); }
      }

      function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        state.theme = savedTheme ? savedTheme : 'system';
        setTheme(state.theme);
      }

      function setTheme(theme) {
        state.theme = theme;
        localStorage.setItem('theme', theme);
        if (theme === 'dark') { document.documentElement.classList.add('dark'); }
        else if (theme === 'light') { document.documentElement.classList.remove('dark'); }
        else {
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) { document.documentElement.classList.add('dark'); }
          else { document.documentElement.classList.remove('dark'); }
        }
        document.getElementById('themeLight').classList.toggle('border-blue-500', theme === 'light');
        document.getElementById('themeLight').classList.toggle('bg-blue-50', theme === 'light');
        document.getElementById('themeDark').classList.toggle('border-blue-500', theme === 'dark');
        document.getElementById('themeDark').classList.toggle('bg-blue-50', theme === 'dark');
        document.getElementById('themeSystem').classList.toggle('border-blue-500', theme === 'system');
        document.getElementById('themeSystem').classList.toggle('bg-blue-50', theme === 'system');
      }

      function initLanguage() {
        const savedLanguage = localStorage.getItem('language');
        if (savedLanguage) {
          state.language = savedLanguage;
          document.getElementById('languageSelect').value = savedLanguage;
        }
      }

      function initNotifications() {
        const savedNotifications = localStorage.getItem('notifications');
        if (savedNotifications) {
          state.notifications = JSON.parse(savedNotifications);
          document.getElementById('notifMessages').checked = state.notifications.messages;
          document.getElementById('notifRequests').checked = state.notifications.requests;
          document.getElementById('notifNews').checked = state.notifications.news;
        }
      }

      function showSettingsModal() { document.getElementById('settingsModal').classList.remove('hidden'); }
      function closeSettingsModal() { document.getElementById('settingsModal').classList.add('hidden'); }
      async function saveSettings() {
        const language = document.getElementById('languageSelect').value;
        const notifications = {
          messages: document.getElementById('notifMessages').checked,
          requests: document.getElementById('notifRequests').checked,
          news: document.getElementById('notifNews').checked
        };
        state.language = language;
        state.notifications = notifications;
        localStorage.setItem('language', language);
        localStorage.setItem('notifications', JSON.stringify(notifications));
        showToast('Настройки сохранены', 'success');
        closeSettingsModal();
      }

      function showHelpModal() { document.getElementById('helpModal').classList.remove('hidden'); }
      function closeHelpModal() { document.getElementById('helpModal').classList.add('hidden'); }
      function showAboutModal() { document.getElementById('aboutModal').classList.remove('hidden'); }
      function closeAboutModal() { document.getElementById('aboutModal').classList.add('hidden'); }

      function showConfirmation(title, message, confirmCallback) {
        document.getElementById('confirmationTitle').textContent = title;
        document.getElementById('confirmationMessage').textContent = message;
        document.getElementById('confirmationModal').classList.remove('hidden');
        const confirmBtn = document.getElementById('confirmActionBtn');
        confirmBtn.onclick = () => {
          document.getElementById('confirmationModal').classList.add('hidden');
          if (confirmCallback) confirmCallback();
        };
      }

      function toggleTemplateFilters() { document.getElementById('marketFilters').classList.toggle('hidden'); }
      function applyTemplateFilters() {
        const category = document.getElementById('templateCategoryFilter').value;
        const price = document.getElementById('templatePriceFilter').value;
        const filters = {};
        if (category !== 'all') filters.category = category;
        if (price !== 'all') filters.price = price;
        loadTemplates(filters);
        document.getElementById('marketFilters').classList.add('hidden');
      }
      function resetTemplateFilters() {
        document.getElementById('templateCategoryFilter').value = 'all';
        document.getElementById('templatePriceFilter').value = 'all';
        loadTemplates();
        document.getElementById('marketFilters').classList.add('hidden');
      }
      function toggleRequestFilters() { document.getElementById('requestFilters').classList.toggle('hidden'); }
      function applyRequestFilters() {
        const budget = document.getElementById('requestBudgetFilter').value;
        const deadline = document.getElementById('requestDeadlineFilter').value;
        const filters = {};
        if (budget !== 'all') filters.budget = budget;
        if (deadline !== 'all') filters.deadline = deadline;
        loadRequests(filters);
        document.getElementById('requestFilters').classList.add('hidden');
      }
      function resetRequestFilters() {
        document.getElementById('requestBudgetFilter').value = 'all';
        document.getElementById('requestDeadlineFilter').value = 'all';
        loadRequests();
        document.getElementById('requestFilters').classList.add('hidden');
      }

      function showLoading(message = 'Загрузка...') {
        document.getElementById('loadingMessage').textContent = message;
        document.getElementById('loadingOverlay').classList.remove('hidden');
        state.isLoading = true;
      }
      function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); state.isLoading = false; }

      function showToast(message, type = 'info') {
        const colors = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500' };
        const toast = document.createElement('div');
        toast.className = `fixed bottom-16 left-1/2 transform -translate-x-1/2 text-white px-4 py-2 rounded-lg shadow-lg ${colors[type]} fade-in flex items-center`;
        toast.innerHTML = `
          <ion-icon name="${type === 'success' ? 'checkmark-circle' : type === 'error' ? 'alert-circle' : type === 'warning' ? 'warning' : 'information-circle'}" class="mr-2"></ion-icon>
          <span>${message}</span>
        `;
        document.body.appendChild(toast);
        setTimeout(() => { toast.classList.add('opacity-0', 'transition-opacity', 'duration-300'); setTimeout(() => toast.remove(), 300); }, 3000);
      }

      // --- Модальные окна для авторизации через Telegram ---
      function showLoginModal() { document.getElementById('loginModal').classList.remove('hidden'); }
      function closeLoginModal() { document.getElementById('loginModal').classList.add('hidden'); }
      // Функции для email регистрации и входа удалены – используется только Telegram

      // Обработка событий
      function setupEventListeners() {
        // Вкладки
        bindEvent(document.getElementById('tab-articles'), 'click', () => switchTab('articles'));
        bindEvent(document.getElementById('tab-market'), 'click', () => switchTab('market'));
        bindEvent(document.getElementById('tab-requests'), 'click', () => switchTab('requests'));
        bindEvent(document.getElementById('tab-profile'), 'click', () => switchTab('profile'));
        // Переключение ролей (если такие кнопки появятся)
        bindEvent(document.getElementById('roleCustBtn'), 'click', () => switchRole('customer'));
        bindEvent(document.getElementById('roleDevBtn'), 'click', () => switchRole('developer'));
        // Кошелек
        bindEvent(document.getElementById('connectWalletBtn'), 'click', connectWallet);
        bindEvent(document.getElementById('disconnectWalletBtn'), 'click', disconnectWallet);
        // Уведомления
        bindEvent(document.getElementById('notifIconWrapper'), 'click', toggleNotifications);
        bindEvent(document.getElementById('markAllAsReadBtn'), 'click', markAllAsRead);
        // Заявки
        bindEvent(document.getElementById('newRequestBtn'), 'click', showAddRequestModal);
        bindEvent(document.getElementById('createRequestBtn'), 'click', showAddRequestModal);
        bindEvent(document.getElementById('refreshRequestsBtn'), 'click', () => loadRequests());
        // Модальные окна заявок
        bindEvent(document.getElementById('closeRequestModalBtn'), 'click', closeAddRequestModal);
        bindEvent(document.getElementById('cancelRequestBtn'), 'click', closeAddRequestModal);
        bindEvent(document.getElementById('submitRequestBtn'), 'click', submitNewRequest);
        bindEvent(document.getElementById('requestDeadline'), 'change', function() {
          document.getElementById('customDeadlineContainer').classList.toggle('hidden', this.value !== 'custom');
        });
        bindEvent(document.getElementById('fileUploadArea'), 'click', () => { document.getElementById('requestFiles').click(); });
        bindEvent(document.getElementById('requestFiles'), 'change', handleRequestFileUpload);
        // Шаблоны
        bindEvent(document.getElementById('addTemplateCard'), 'click', showAddTemplateModal);
        bindEvent(document.getElementById('filterTemplatesBtn'), 'click', toggleTemplateFilters);
        bindEvent(document.getElementById('applyFiltersBtn'), 'click', applyTemplateFilters);
        bindEvent(document.getElementById('resetFiltersBtn'), 'click', resetTemplateFilters);
        bindEvent(document.getElementById('resetFiltersBtn2'), 'click', resetTemplateFilters);
        // Модальное окно шаблона
        bindEvent(document.getElementById('closeTemplateModalBtn'), 'click', closeAddTemplateModal);
        bindEvent(document.getElementById('cancelTemplateBtn'), 'click', closeAddTemplateModal);
        bindEvent(document.getElementById('submitTemplateBtn'), 'click', submitNewTemplate);
        bindEvent(document.getElementById('templateFileUpload'), 'click', () => { document.getElementById('templateFile').click(); });
        bindEvent(document.getElementById('templateFile'), 'change', handleTemplateFileUpload);
        bindEvent(document.getElementById('templatePreviewUpload'), 'click', () => { document.getElementById('templatePreview').click(); });
        bindEvent(document.getElementById('templatePreview'), 'change', handleTemplatePreviewUpload);
        // Фильтры заявок
        bindEvent(document.getElementById('filterRequestsBtn'), 'click', toggleRequestFilters);
        bindEvent(document.getElementById('applyRequestFiltersBtn'), 'click', applyRequestFilters);
        bindEvent(document.getElementById('resetRequestFiltersBtn'), 'click', resetRequestFilters);
        // Чат
        bindEvent(document.getElementById('closeChatBtn'), 'click', closeChat);
        bindEvent(document.getElementById('chatSendBtn'), 'click', sendMessage);
        bindEvent(document.getElementById('chatInput'), 'keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
        bindEvent(document.getElementById('attachFileBtn'), 'click', (e) => { e.stopPropagation(); document.getElementById('attachmentOptions').classList.toggle('hidden'); });
        document.addEventListener('click', (e) => {
          if (!e.target.closest('#attachmentOptions') && !e.target.closest('#attachFileBtn')) { document.getElementById('attachmentOptions').classList.add('hidden'); }
        });
        // Профиль
        bindEvent(document.getElementById('settingsBtn'), 'click', showSettingsModal);
        bindEvent(document.getElementById('helpBtn'), 'click', showHelpModal);
        bindEvent(document.getElementById('aboutBtn'), 'click', showAboutModal);
        bindEvent(document.getElementById('loadMoreHistory'), 'click', loadMoreHistory);
        // Модальное окно настроек
        bindEvent(document.getElementById('closeSettingsBtn'), 'click', closeSettingsModal);
        bindEvent(document.getElementById('saveSettingsBtn'), 'click', saveSettings);
        // Кнопки темы
        bindEvent(document.getElementById('themeLight'), 'click', () => setTheme('light'));
        bindEvent(document.getElementById('themeDark'), 'click', () => setTheme('dark'));
        bindEvent(document.getElementById('themeSystem'), 'click', () => setTheme('system'));
        // Модальное окно помощи
        bindEvent(document.getElementById('closeHelpBtn'), 'click', closeHelpModal);
        // Модальное окно "О приложении"
        bindEvent(document.getElementById('closeAboutBtn'), 'click', closeAboutModal);
        // Модальное окно подтверждения
        bindEvent(document.getElementById('cancelConfirmBtn'), 'click', () => { document.getElementById('confirmationModal').classList.add('hidden'); });
      }

      // Запускаем инициализацию приложения (авторизация осуществляется только через Telegram)
      initApp();

    });
  </script>
</body>
</html>
